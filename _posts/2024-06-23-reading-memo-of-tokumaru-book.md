---
title: 徳丸本の読書メモ
last_modified_at: 2024-06-23T10:38:16
categories:
  - blog
tags: security
---

[徳丸本](https://www.amazon.co.jp/%E4%BD%93%E7%B3%BB%E7%9A%84%E3%81%AB%E5%AD%A6%E3%81%B6-%E5%AE%89%E5%85%A8%E3%81%AAWeb%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E4%BD%9C%E3%82%8A%E6%96%B9-%E7%AC%AC2%E7%89%88-%E8%84%86%E5%BC%B1%E6%80%A7%E3%81%8C%E7%94%9F%E3%81%BE%E3%82%8C%E3%82%8B%E5%8E%9F%E7%90%86%E3%81%A8%E5%AF%BE%E7%AD%96%E3%81%AE%E5%AE%9F%E8%B7%B5-%E5%BE%B3%E4%B8%B8/dp/4797393165)を読んだので、メモを残しておく。ほんとに自分用のメモでしかないが、そのうち清書するかもしれない。

## xssについて

本質は、
- 外部から来た文字列を
- エスケープせずに
- 自ドメインのレスポンスとして

返してしまうこと。

- 内部で作った文字列なら、単なるミスで攻撃ではない
- エスケープしてれば攻撃を防げる
- ブラウザは、サンドボックスの仕組みで、安易に表示中のドメイン以外に由来する文字列をレンダリングしたりJSとして実行したりはしないが、まさに表示しているドメインから送られてきた文字列であれば実行するしかない

つまり、xssは、外部からの入力を元に動的にページを作る部分の脆弱性をついて、不正なコードを正当なレスポンスとして返させられる攻撃。レスポンスを作るために利用し得る外部からの入力てあれば、何でも脆弱性の源になり得る。

攻撃を成立させるためには、被害ユーザー自身に、攻撃を成立させる入力値を、被害サイトのサーバーに送らせる必要がある。このために、URLパラメタやフォームの値などに有害入力を仕込んだリンクなどを外部サイトに置いて、それを被害ユーザーに踏ませるのが典型例。

## CSRFについて

ブラウザは、サーバーにリクエストを送る際に、そのドメインのクッキーがあれば、それをリクエストに付加する。

普通、クッキーのセッション情報を見てログイン状態が判定される。これは、たとえ悪意あるリンクを踏んだり、悪意あるフォームによってPOSTする場合も同じ。

したがって、何らかの方法でログイン状態にあるユーザーのブラウザでリンクを踏ませたりフォームからポストさせたりできれば、サーバーに認証済みのリクエストを送ることができる。

xssとは異なり、この不正リクエストは、被害サイトと異なるドメインからも送ることができる。しかし、外部ドメインからのリクエストの場合は、レスポンスの内容を悪意あるサイトのjsなどから盗み見ることはできない。つまり、攻撃の範囲はサーバー側での副作用に限定される。

対策として、当該のリクエスト（リンクによる遷移やフォームからのポスト）に検証用のトークンを含むことを要求する（含まれてなかったらリクエストを捨てるなりエラーを返すなりする）。サーバー側で、誰に・どのトークンを送ったかを管理しておけば、攻撃者が用意したニセのトークンを含むリクエストを送らされても拒否することができる。
